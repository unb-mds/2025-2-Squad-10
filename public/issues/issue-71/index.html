<!DOCTYPE html>
<html lang="pt-br">
<head><script src="/2025-2-OncoMap/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=2025-2-OncoMap/livereload" data-no-instant defer></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>
        
            [TASK] - Add .txt ao db | OncoMap
        
    </title>
    

    
    
    
    
    
    
    
    
    
    
    
        
        
    

    
    
    
    
    
    
    
    
    
    
    <link rel="stylesheet" href="http://localhost:1313/2025-2-OncoMap/css/issues-page-bundle.min.css">



</head>
<body>

    <nav class="navbar">

    <a class="navbar-brand" href="http://localhost:1313/2025-2-OncoMap/">
        OncoMap
    </a>

    <ul class="navbar-links">
        <li><a href="http://localhost:1313/2025-2-OncoMap/">In√≠cio</a></li>
        <li><a href="http://localhost:1313/2025-2-OncoMap/sprints/">Sprints</a></li>
        <li><a href="http://localhost:1313/2025-2-OncoMap/requisitos/">Requisitos</a></li>
        <li><a href="http://localhost:1313/2025-2-OncoMap/arquitetura/">Arquitetura</a></li>
        <li><a href="http://localhost:1313/2025-2-OncoMap/diversos/">Diversos</a></li>
        <li><a href="http://localhost:1313/2025-2-OncoMap/doc/">Documenta√ß√£o</a></li>
    </ul>

    <div class="navbar-right">
        <a href="https://github.com/unb-mds/2025-2-OncoMap" target="_blank">GitHub</a>
    </div>

</nav>

    <section class="hero">
    <div class="container">
        <h1>[TASK] - Add .txt ao db</h1>
        
        
        
        </div>
</section>

    <main>
        

    <div class="container page-single">
        <h1>[TASK] - Add .txt ao db</h1>
        
        <div class="content">
            <h2 id="-objetivo--motiva√ß√£o">üéØ Objetivo / Motiva√ß√£o</h2>
<p>Atualizar a tabela <code>mentions</code> do banco de dados, preenchendo a coluna <code>txt_url</code> para os registros onde ela est√° atualmente <code>NULL</code>. O script (<code>fill_missing_txt_urls.js</code>) buscar√° na API do Querido Di√°rio o <code>txt_url</code> correspondente a cada di√°rio j√° coletado.</p>
<p>Esta tarefa √© necess√°ria para maximizar a qualidade dos dados usados pelo script de enriquecimento (<code>enrichment.js</code>). O conte√∫do completo do arquivo <code>.txt</code> geralmente fornece mais contexto do que o <code>excerpt</code>, aumentando a precis√£o da extra√ß√£o de valores financeiros pela IA. Resolve o problema de termos apenas <code>excerpts</code> para muitos registros.</p>
<hr>
<h2 id="-escopo-da-tarefa-e-entreg√°veis">üìã Escopo da Tarefa e Entreg√°veis</h2>
<ul>
<li><input checked="" disabled="" type="checkbox"> <strong>Modificar Tabela <code>mentions</code>:</strong> Garantir que a coluna <code>txt_url</code> (TEXT, nullable) exista.</li>
<li><input checked="" disabled="" type="checkbox"> <strong>Criar Script <code>fill_missing_txt_urls.js</code>:</strong> Desenvolver o script na pasta <code>scripts/</code>.</li>
<li><input checked="" disabled="" type="checkbox"> <strong>L√≥gica de Busca:</strong> Implementar a query <code>SELECT id, municipality_ibge_code, publication_date, source_url FROM mentions WHERE txt_url IS NULL</code>.</li>
<li><input checked="" disabled="" type="checkbox"> <strong>Consulta √† API Querido Di√°rio:</strong> Para cada men√ß√£o, fazer uma requisi√ß√£o <code>GET</code> √† API buscando pelo <code>municipality_ibge_code</code> e a <code>publication_date</code> exata.</li>
<li><input checked="" disabled="" type="checkbox"> <strong>Identifica√ß√£o do Di√°rio:</strong> No resultado da API, encontrar o <code>gazette</code> cujo <code>url</code> (link do PDF) corresponda ao <code>source_url</code> da men√ß√£o no banco.</li>
<li><input checked="" disabled="" type="checkbox"> <strong>Extra√ß√£o e Atualiza√ß√£o:</strong> Extrair o <code>txt_url</code> do <code>gazette</code> correspondente (se existir) e executar uma query <code>UPDATE mentions SET txt_url = $1 WHERE id = $2</code> para salvar o valor encontrado (ou <code>NULL</code> se n√£o foi encontrado).</li>
<li><input checked="" disabled="" type="checkbox"> <strong>Controle de Velocidade:</strong> Implementar um <code>delay</code> entre as requisi√ß√µes √† API do Querido Di√°rio.</li>
<li><input checked="" disabled="" type="checkbox"> <strong>Adicionar Comando <code>npm</code>:</strong> Adicionar o script <code>db:fill-txt</code> ao <code>package.json</code>.</li>
</ul>
<hr>
<h2 id="-crit√©rios-de-aceita√ß√£o">‚úÖ Crit√©rios de Aceita√ß√£o</h2>
<ul>
<li><input checked="" disabled="" type="checkbox"> O script <code>fill_missing_txt_urls.js</code> existe na pasta <code>scripts/</code> e executa sem erros fatais.</li>
<li><input checked="" disabled="" type="checkbox"> O script identifica corretamente as men√ß√µes na tabela <code>mentions</code> com <code>txt_url IS NULL</code>.</li>
<li><input checked="" disabled="" type="checkbox"> As consultas √† API do Querido Di√°rio s√£o feitas corretamente para a data e munic√≠pio espec√≠ficos.</li>
<li><input checked="" disabled="" type="checkbox"> O script consegue encontrar o <code>gazette</code> correspondente na resposta da API usando o <code>source_url</code>.</li>
<li><input checked="" disabled="" type="checkbox"> A coluna <code>txt_url</code> na tabela <code>mentions</code> √© atualizada com a URL encontrada ou permanece <code>NULL</code> (mas a linha n√£o √© mais selecionada pelo script em execu√ß√µes futuras se a atualiza√ß√£o ocorrer, mesmo que para <code>NULL</code>).</li>
<li><input checked="" disabled="" type="checkbox"> O script processa todas as men√ß√µes pendentes e termina.</li>
<li><input checked="" disabled="" type="checkbox"> O comando <code>npm run db:fill-txt</code> executa o script corretamente.</li>
</ul>
<hr>
<h2 id="-depend√™ncias-opcional">üîó Depend√™ncias (Opcional)</h2>
<ul>
<li>Depende da exist√™ncia da tabela <code>mentions</code> com as colunas <code>municipality_ibge_code</code>, <code>publication_date</code>, e <code>source_url</code> populadas.</li>
<li>Depende da exist√™ncia da coluna <code>txt_url</code> na tabela <code>mentions</code>.</li>
<li>A Issue de Enriquecimento (<code>enrichment.js</code>) pode se beneficiar desta, mas n√£o depende estritamente (possui fallback).</li>
</ul>
<hr>
<h2 id="-sugest√£o-de-implementa√ß√£o-opcional">üí° Sugest√£o de Implementa√ß√£o (Opcional)</h2>
<ul>
<li>Utilizar <code>axios</code> para fazer as chamadas √† API do Querido Di√°rio.</li>
<li>Otimizar a busca na API consultando apenas pela data espec√≠fica (<code>published_since</code> e <code>published_until</code> iguais).</li>
<li>Usar o m√©todo <code>find()</code> do JavaScript no array <code>gazettes</code> retornado pela API para encontrar o <code>gazette</code> correspondente √† <code>source_url</code>.</li>
<li>Garantir que o <code>UPDATE</code> no banco seja feito mesmo se <code>txt_url</code> n√£o for encontrado, para evitar reprocessamento desnecess√°rio (talvez atualizando para <code>NULL</code> explicitamente ou adicionando uma coluna <code>txt_url_checked_at</code>). <em>Corre√ß√£o: O script atualizado j√° faz isso ao definir <code>txt_url = $1</code> onde <code>$1</code> pode ser <code>null</code>.</em></li>
<li><strong>Executar o script usando <code>screen</code></strong> devido √† potencial longa dura√ß√£o (horas, dependendo do n√∫mero de men√ß√µes com <code>txt_url</code> nulo).</li>
</ul>
<hr>
<details>
<summary>Checklist do Autor</summary>
<ul>
<li><input disabled="" type="checkbox"> Verifiquei se n√£o h√° uma tarefa duplicada j√° aberta.</li>
<li><input disabled="" type="checkbox"> O t√≠tulo da tarefa √© claro e conciso.</li>
<li><input disabled="" type="checkbox"> Descrevi o objetivo e a motiva√ß√£o por tr√°s da tarefa.</li>
<li><input disabled="" type="checkbox"> Os entreg√°veis e os crit√©rios de aceita√ß√£o est√£o bem definidos.</li>
<li><input disabled="" type="checkbox"> Associei a tarefa a um projeto (Project) ou marco (Milestone), se aplic√°vel.</li>
</ul>
</details>
        </div>
    </div>


    </main>

    <footer class="footer">
    <div class="container">
        <div class="footer-grid">
            
            <div class="footer-column about">
                <h3>OncoMap</h3>
                <p>Mapa de investimento em sa√∫de oncol√≥gica</p>
            </div>
            
            <div class="footer-column links">
                <h3>Links √öteis</h3>
                <ul>
                    <li><a href="http://localhost:1313/2025-2-OncoMap/">In√≠cio</a></li>
                    <li><a href="http://localhost:1313/2025-2-OncoMap/sprints">Sprints</a></li>
                    
                    
                    
                    
                        <li><a href="http://localhost:1313/2025-2-OncoMap/requisitos/">Requisitos</a></li>
                    
                    
                    
                    
                        <li><a href="http://localhost:1313/2025-2-OncoMap/arquitetura/">Arquitetura</a></li>
                    
                </ul>
            </div>
            
            <div class="footer-column contact">
                <h3>Contato</h3>
                <ul>
                    <li><a href="https://github.com/unb-mds/2025-2-OncoMap" target="_blank">GitHub</a></li>
                </ul>
            </div>

        </div>
    </div>
    
    <div class="footer-bottom">
        <div class="container">
            <p>&copy; 2025 OncoMap. Todos os direitos reservados.</p>
            <p>Desenvolvido pela equipe UnB-MDS</p>
        </div>
    </div>
</footer>
    
    <script src="http://localhost:1313/2025-2-OncoMap/js/app.js"></script>
</body>
</html>