<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>
        
            Implementa√ß√£o script para txt | OncoMap
        
    </title>
    

    
    
    
    
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
    
    
    
    <link rel="stylesheet" href="https://unb-mds.github.io/2025-2-OncoMap/css/issues-page-bundle.min.css">



</head>
<body>

    <nav class="navbar">

    <a class="navbar-brand" href="https://unb-mds.github.io/2025-2-OncoMap/">
        OncoMap
    </a>

    <ul class="navbar-links">
        <li><a href="https://unb-mds.github.io/2025-2-OncoMap/">In√≠cio</a></li>
        <li><a href="https://unb-mds.github.io/2025-2-OncoMap/sprints/">Sprints</a></li>
        <li><a href="https://unb-mds.github.io/2025-2-OncoMap/requisitos/">Requisitos</a></li>
        <li><a href="https://unb-mds.github.io/2025-2-OncoMap/arquitetura/">Arquitetura</a></li>
        <li><a href="https://unb-mds.github.io/2025-2-OncoMap/diversos/">Diversos</a></li>
    </ul>

    <div class="navbar-right">
        <a href="https://github.com/unb-mds/2025-2-OncoMap" target="_blank">GitHub</a>
    </div>

</nav>

    <section class="hero">
    <div class="container">
        <h1>Implementa√ß√£o script para txt</h1>
        
        
        
        </div>
</section>

    <main>
        

    <div class="container page-single">
        <h1>Implementa√ß√£o script para txt</h1>
        
        <div class="content">
            <h2 id="-descri√ß√£o">üéØ Descri√ß√£o</h2>
<p>Implementar um pipeline de &ldquo;An√°lise Dupla&rdquo; para o enriquecimento de dados da IA.</p>
<p>O sistema deve analisar <strong>duas fontes de texto</strong> de forma independente para cada men√ß√£o:</p>
<ol>
<li><strong>Fonte PDF:</strong> (Script <code>enrichment_pdf.js</code>) Analisa o <code>source_url</code> (PDF) usando <code>pdf-parse</code>.</li>
<li><strong>Fonte TXT:</strong> (Novo script <code>enrichment_txt.js</code>) Analisa o <code>txt_url</code> ou o <code>excerpt</code>.</li>
</ol>
<p>Os resultados de cada an√°lise ser√£o salvos em colunas separadas, permitindo 100% de cobertura de an√°lise e valida√ß√£o cruzada dos dados.</p>
<hr>
<h2 id="-objetivo">‚úÖ Objetivo</h2>
<p>Qual problema essa feature resolve?</p>
<ul>
<li>O pipeline atual, focado apenas em PDF (<code>enrichment_pdf.js</code>), <strong>ignora men√ß√µes</strong> onde o PDF n√£o est√° dispon√≠vel, est√° corrompido, ou o <code>pdf-parse</code> falha. Isso cria &ldquo;buracos&rdquo; no banco de dados.</li>
<li>N√£o temos uma forma de &ldquo;plano B&rdquo; (fallback) para analisar os dados de texto (o <code>.txt</code> original ou o <code>excerpt</code>) que o <code>collector.js</code> salva.</li>
</ul>
<p>Por que ela √© importante para o projeto?</p>
<ul>
<li><strong>Cobertura de 100%:</strong> Garante que <strong>todas as men√ß√µes</strong> coletadas (seja PDF ou TXT) passem por uma an√°lise de IA, maximizando a quantidade de dados extra√≠dos.</li>
<li><strong>Valida√ß√£o de Dados:</strong> Ao ter duas an√°lises (<code>gemini_analysis</code> e <code>gemini_analysis_txt</code>), podemos comparar os resultados, validar a precis√£o da IA e escolher a melhor fonte de dados para o frontend.</li>
<li><strong>Robustez:</strong> O pipeline se torna mais resiliente, pois uma falha na an√°lise do PDF n√£o impede mais a an√°lise do TXT.</li>
</ul>
<hr>
<h2 id="-detalhes-da-implementa√ß√£o">üìù Detalhes da Implementa√ß√£o</h2>
<p>Se j√° tiver uma ideia de como implementar, descreva aqui.</p>
<ul>
<li><strong>Banco de Dados:</strong> Adicionar duas novas colunas √† tabela <code>mentions</code> no Supabase:
<ul>
<li><code>gemini_analysis_txt</code> (do tipo <code>JSONB</code>)</li>
<li><code>extracted_value_txt</code> (do tipo <code>NUMERIC(15, 2)</code>)</li>
</ul>
</li>
<li><strong>Refatora√ß√£o:</strong> O script <code>enrichment_pdf.js</code> permanece o mesmo, focado em <code>source_url</code> e salvando em <code>gemini_analysis</code>.</li>
<li>
<ul>
<li><strong>Novo Script:</strong> Criar o <code>enrichment_txt.js</code> , que ser√° uma c√≥pia do <code>enrichment_pdf.js</code> com as seguintes modifica√ß√µes:
<ul>
<li><strong>Depend√™ncias:</strong> Remover <code>pdf-parse</code>. Manter <code>tiktoken</code> (para chunking).</li>
<li><strong>Fonte de Dados:</strong> Modificar a l√≥gica de <em>download</em> para baixar o <code>txt_url</code> (se existir) ou usar o <code>excerpt</code> (como fallback).</li>
<li><strong>L√≥gica de Chunking:</strong> Manter a l√≥gica de <code>splitTextIntoChunksByToken</code>, pois o <code>.txt</code> ou <code>excerpt</code> pode ser maior que o limite de 1 milh√£o de tokens.</li>
<li><strong>Query SQL:</strong> Modificar a query principal para buscar men√ß√µes onde <code>gemini_analysis_txt IS NULL</code> (para rodar em todos os munic√≠pios, independentemente do sucesso do PDF) e onde <code>(txt_url IS NOT NULL OR excerpt IS NOT NULL)</code>.</li>
<li><strong>Destino (Salvar):</strong> O script deve salvar seus resultados nas novas colunas (<code>gemini_analysis_txt</code> e <code>extracted_value_txt</code>).</li>
</ul>
</li>
</ul>
</li>
<li><strong>Fluxo de Trabalho:</strong> O enriquecimento total ser√° feito em duas fases (separadas ou paralelas):
<ol>
<li><code>node src/scripts/enrichment_pdf.js [startId] [endId]</code></li>
<li><code>node src/scripts/enrichment_txt.js [startId] [endId]</code></li>
</ol>
</li>
</ul>
<hr>
<h2 id="-crit√©rios-de-aceita√ß√£o">üìä Crit√©rios de Aceita√ß√£o</h2>
<p>Quais pontos devem estar presentes para considerar a feature conclu√≠da?</p>
<ul>
<li><input checked="" disabled="" type="checkbox"> As novas colunas <code>gemini_analysis_txt</code> e <code>extracted_value_txt</code> existem no banco de dados.</li>
<li><input checked="" disabled="" type="checkbox"> O novo script <code>enrichment_txt.js</code> existe e implementa a mesma arquitetura (Roteador de Chaves, <code>tiktoken</code>, <code>chunking</code>, processamento por ID).</li>
<li><input checked="" disabled="" type="checkbox"> O <code>enrichment_txt.js</code> busca corretamente as fontes de texto (<code>txt_url</code> ou <code>excerpt</code>).</li>
<li><input checked="" disabled="" type="checkbox"> O <code>enrichment_txt.js</code> salva com sucesso os resultados nas novas colunas <code>gemini_analysis_txt</code> e <code>extracted_value_txt</code>.</li>
<li><input checked="" disabled="" type="checkbox"> O script <code>enrichment_pdf.js</code> permanece funcional e salva os resultados nas colunas <code>gemini_analysis</code> originais.</li>
</ul>
<hr>

        </div>
    </div>


    </main>

    <footer class="footer">
    <div class="container">
        <div class="footer-grid">
            
            <div class="footer-column about">
                <h3>OncoMap</h3>
                <p>Mapa de investimento em sa√∫de oncol√≥gica</p>
            </div>
            
            <div class="footer-column links">
                <h3>Links √öteis</h3>
                <ul>
                    <li><a href="https://unb-mds.github.io/2025-2-OncoMap/">In√≠cio</a></li>
                    <li><a href="https://unb-mds.github.io/2025-2-OncoMap/sprints">Sprints</a></li>
                    
                    
                    
                    
                        <li><a href="https://unb-mds.github.io/2025-2-OncoMap/requisitos/">Requisitos</a></li>
                    
                    
                    
                    
                        <li><a href="https://unb-mds.github.io/2025-2-OncoMap/arquitetura/">Arquitetura</a></li>
                    
                </ul>
            </div>
            
            <div class="footer-column contact">
                <h3>Contato</h3>
                <ul>
                    <li><a href="https://github.com/unb-mds/2025-2-OncoMap" target="_blank">GitHub</a></li>
                </ul>
            </div>

        </div>
    </div>
    
    <div class="footer-bottom">
        <div class="container">
            <p>&copy; 2025 OncoMap. Todos os direitos reservados.</p>
            <p>Desenvolvido pela equipe UnB-MDS</p>
        </div>
    </div>
</footer>
    
    <script src="https://unb-mds.github.io/2025-2-OncoMap/js/app.js"></script>
</body>
</html>