<!doctype html><html lang=pt-br><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>[TASK] - Enrichment.js | OncoMap</title><link rel=stylesheet href=https://unb-mds.github.io/2025-2-OncoMap/css/issues-page-bundle.min.css></head><body><nav class=navbar><a class=navbar-brand href=https://unb-mds.github.io/2025-2-OncoMap/>OncoMap</a><ul class=navbar-links><li><a href=https://unb-mds.github.io/2025-2-OncoMap/>In√≠cio</a></li><li><a href=https://unb-mds.github.io/2025-2-OncoMap/sprints/>Sprints</a></li><li><a href=https://unb-mds.github.io/2025-2-OncoMap/requisitos/>Requisitos</a></li><li><a href=https://unb-mds.github.io/2025-2-OncoMap/arquitetura/>Arquitetura</a></li><li><a href=https://unb-mds.github.io/2025-2-OncoMap/diversos/>Diversos</a></li></ul><div class=navbar-right><a href=https://github.com/unb-mds/2025-2-OncoMap target=_blank>GitHub</a></div></nav><section class=hero><div class=container><h1>[TASK] - Enrichment.js</h1></div></section><main><div class="container page-single"><h1>[TASK] - Enrichment.js</h1><div class=content><h2 id=-objetivo--motiva√ß√£o>üéØ Objetivo / Motiva√ß√£o</h2><p>Implementar o script principal (<code>enrichment.js</code>) que processa os dados brutos coletados (excerpts ou textos completos) utilizando a API do Google Gemini. O objetivo √© extrair informa√ß√µes estruturadas (valores monet√°rios totais e categorizados) sobre investimentos oncol√≥gicos e salvar esses dados enriquecidos de volta no banco de dados.</p><p>Esta tarefa √© crucial pois transforma os trechos de texto n√£o estruturados em dados quantific√°veis e categorizados, que s√£o essenciais para a visualiza√ß√£o e an√°lise no frontend do OncoMap. Resolve o problema de termos apenas &ldquo;evid√™ncias brutas&rdquo; e permite a gera√ß√£o de insights.</p><hr><h2 id=-escopo-da-tarefa-e-entreg√°veis>üìã Escopo da Tarefa e Entreg√°veis</h2><ul><li><input checked disabled type=checkbox> <strong>Modificar Tabela <code>mentions</code>:</strong> Garantir que as colunas <code>gemini_analysis</code> (JSONB) e <code>extracted_value</code> (NUMERIC) existam.</li><li><input checked disabled type=checkbox> <strong>Criar Script <code>enrichment.js</code>:</strong> Desenvolver o script principal na pasta <code>scripts/</code>.</li><li><input checked disabled type=checkbox> <strong>L√≥gica de Sele√ß√£o de Fonte:</strong> Implementar a l√≥gica que prioriza o download do conte√∫do do <code>txt_url</code> (se dispon√≠vel) e usa o <code>excerpt</code> como fallback.</li><li><input checked disabled type=checkbox> <strong>Desenvolver Prompt Refinado:</strong> Implementar a fun√ß√£o <code>getGeminiPrompt</code> com instru√ß√µes detalhadas para extrair o JSON estruturado (<code>total_gasto_oncologico</code>, <code>medicamentos</code>, <code>equipamentos</code>, <code>estadia_paciente</code>, <code>obras_infraestrutura</code>, <code>servicos_saude</code>, <code>outros_relacionados</code>).</li><li><input checked disabled type=checkbox> <strong>Integra√ß√£o com Gemini API:</strong> Implementar a chamada √† API do Gemini (<code>gemini-flash-latest</code>) usando o SDK <code>@google/generative-ai</code>.</li><li><input checked disabled type=checkbox> <strong>L√≥gica de Limpeza e C√°lculo:</strong> Implementar a fun√ß√£o <code>extractJsonFromString</code> para extrair o JSON da resposta e recalcular o <code>total_gasto_oncologico</code> localmente para garantir precis√£o.</li><li><input checked disabled type=checkbox> <strong>Tratamento de Erros e Rate Limit:</strong> Implementar a l√≥gica de <code>try...catch</code> com retentativas (exponential backoff) para erros <code>429 Too Many Requests</code> e tratamento para outros erros da API ou de parsing.</li><li><input checked disabled type=checkbox> <strong>Controle de Velocidade:</strong> Implementar um <code>delay</code> configur√°vel entre as chamadas ao Gemini para respeitar os limites e a boa vizinhan√ßa da API.</li><li><input checked disabled type=checkbox> <strong>Atualiza√ß√£o do Banco de Dados:</strong> Implementar a query <code>UPDATE mentions</code> para salvar o <code>gemini_analysis</code> (JSON) e o <code>extracted_value</code> (NUMERIC calculado) na linha correspondente.</li><li><input checked disabled type=checkbox> <strong>Adicionar Comando <code>npm</code>:</strong> Adicionar o script <code>db:enrich</code> ao <code>package.json</code>.</li></ul><hr><h2 id=-crit√©rios-de-aceita√ß√£o>‚úÖ Crit√©rios de Aceita√ß√£o</h2><ul><li><input checked disabled type=checkbox> O script <code>enrichment.js</code> existe na pasta <code>scripts/</code> e executa sem erros fatais.</li><li><input checked disabled type=checkbox> O script identifica corretamente as men√ß√µes na tabela <code>mentions</code> que ainda n√£o foram processadas (<code>gemini_analysis IS NULL</code>).</li><li><input checked disabled type=checkbox> O script tenta baixar o conte√∫do do <code>txt_url</code> quando dispon√≠vel e usa o <code>excerpt</code> como fallback.</li><li><input checked disabled type=checkbox> As chamadas para a API do Gemini s√£o feitas usando o prompt refinado.</li><li><input checked disabled type=checkbox> Erros <code>429</code> da API do Gemini acionam a l√≥gica de espera e retentativa configurada.</li><li><input checked disabled type=checkbox> A resposta do Gemini √© limpa, e o JSON √© extra√≠do ou um erro √© registrado se a extra√ß√£o falhar.</li><li><input checked disabled type=checkbox> O valor total (<code>extracted_value</code>) √© calculado corretamente a partir das categorias no script.</li><li><input checked disabled type=checkbox> Os dados (<code>gemini_analysis</code> e <code>extracted_value</code>) s√£o salvos corretamente na tabela <code>mentions</code> ap√≥s o processamento bem-sucedido.</li><li><input checked disabled type=checkbox> O script processa todas as men√ß√µes pendentes e termina.</li><li><input checked disabled type=checkbox> O comando <code>npm run db:enrich</code> executa o script corretamente.</li></ul><hr><h2 id=-depend√™ncias-opcional>üîó Depend√™ncias (Opcional)</h2><ul><li>Depende da exist√™ncia da tabela <code>mentions</code> com as colunas <code>excerpt</code> e <code>source_url</code> populadas (resultado da Issue da coleta inicial).</li><li>Depende da exist√™ncia das colunas <code>txt_url</code>, <code>gemini_analysis</code>, e <code>extracted_value</code> na tabela <code>mentions</code>.</li><li>Para melhores resultados, depende da conclus√£o da Issue de preenchimento dos <code>txt_url</code>s faltantes, mas possui fallback para <code>excerpt</code>.</li></ul><hr><h2 id=-sugest√£o-de-implementa√ß√£o-opcional>üí° Sugest√£o de Implementa√ß√£o (Opcional)</h2><ul><li>Utilizar o SDK <code>@google/generative-ai</code> para interagir com o Gemini.</li><li>Utilizar <code>axios</code> para baixar o conte√∫do dos <code>txt_url</code>s.</li><li>Implementar a l√≥gica de sele√ß√£o de fonte (<code>txt</code> vs <code>excerpt</code>) e o tratamento de erro de download.</li><li>Implementar a fun√ß√£o <code>extractJsonFromString</code> usando <code>indexOf('{')</code> e <code>lastIndexOf('}')</code> ou Regex mais robusto.</li><li>Implementar o loop de retentativa (<code>while (attempt &lt; maxRetries)</code>) dentro de uma fun√ß√£o <code>processMention</code> separada para modularidade.</li><li>Usar <code>JSON.stringify</code> para salvar o objeto <code>analysisData</code> na coluna <code>JSONB</code>.</li><li><strong>Executar o script usando <code>screen</code></strong> devido √† longa dura√ß√£o estimada (horas).</li></ul><hr><details><summary>Checklist do Autor</summary><ul><li><input disabled type=checkbox> Verifiquei se n√£o h√° uma tarefa duplicada j√° aberta.</li><li><input disabled type=checkbox> O t√≠tulo da tarefa √© claro e conciso.</li><li><input disabled type=checkbox> Descrevi o objetivo e a motiva√ß√£o por tr√°s da tarefa.</li><li><input disabled type=checkbox> Os entreg√°veis e os crit√©rios de aceita√ß√£o est√£o bem definidos.</li><li><input disabled type=checkbox> Associei a tarefa a um projeto (Project) ou marco (Milestone), se aplic√°vel.</li></ul></details></div></div></main><footer class=footer><div class=container><div class=footer-grid><div class="footer-column about"><h3>OncoMap</h3><p>Mapa de investimento em sa√∫de oncol√≥gica</p></div><div class="footer-column links"><h3>Links √öteis</h3><ul><li><a href=https://unb-mds.github.io/2025-2-OncoMap/>In√≠cio</a></li><li><a href=https://unb-mds.github.io/2025-2-OncoMap/sprints>Sprints</a></li><li><a href=https://unb-mds.github.io/2025-2-OncoMap/requisitos/>Requisitos</a></li><li><a href=https://unb-mds.github.io/2025-2-OncoMap/arquitetura/>Arquitetura</a></li></ul></div><div class="footer-column contact"><h3>Contato</h3><ul><li><a href=https://github.com/unb-mds/2025-2-OncoMap target=_blank>GitHub</a></li></ul></div></div></div><div class=footer-bottom><div class=container><p>&copy; 2025 OncoMap. Todos os direitos reservados.</p><p>Desenvolvido pela equipe UnB-MDS</p></div></div></footer><script src=https://unb-mds.github.io/2025-2-OncoMap/js/app.js></script></body></html>